esphome:
  name: tez-teltonika-gateway
  name_add_mac_suffix: true
  friendly_name: Tez Teltonika EYE Gateway
  comment: ESP32 BLE bridge for Teltonika EYE sensors
  platformio_options:
    lib_ldf_mode: deep+

esp32:
  board: esp32dev
  framework:
    type: arduino

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Tez Teltonika Gateway Fallback"
    password: "TezDevice#123"

captive_portal:

logger:
  level: INFO
  logs:
    teltonika_ble: INFO
    esp32_ble_tracker: INFO

api:

ota:
  - platform: esphome
    id: ota_esphome

web_server:
  port: 80

time:
  - platform: sntp
    id: sntp_time

esp32_ble_tracker:
  scan_parameters:
    interval: 320ms
    window: 30ms
    active: false

external_components:
  - source: github://VignanTej/teltonika-eye-homeassistant
    components:
      - teltonika_ble
    refresh: 0s

teltonika_ble:
  id: teltonika_ble_component
  discover: true
  timeout: 300s

# ---------------- DISCOVERED DEVICES TEXT SENSOR -------------------------

text_sensor:
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    discovered_devices:
      name: "Teltonika Devices Discovered"
      icon: "mdi:bluetooth-audio"

  - platform: wifi_info
    ip_address:
      name: "Gateway IP"
    mac_address:
      name: "Gateway MAC"

# ---------------- CONFIG TEXT FIELDS (SHOW IN HA DEVICE UI) -------------

text:
  - platform: template
    id: eye1_mac_text
    name: "EYE 1 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "7C:D9:F4:13:BD:BF"
    min_length: 0
    max_length: 17
    mode: text

  - platform: template
    id: eye2_mac_text
    name: "EYE 2 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "7C:D9:F4:14:21:5D"
    min_length: 0
    max_length: 17
    mode: text

  - platform: template
    id: eye3_mac_text
    name: "EYE 3 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "00:00:00:00:00:00"
    min_length: 0
    max_length: 17
    mode: text

  - platform: template
    id: eye4_mac_text
    name: "EYE 4 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "00:00:00:00:00:00"
    min_length: 0
    max_length: 17
    mode: text

  - platform: template
    id: eye5_mac_text
    name: "EYE 5 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "00:00:00:00:00:00"
    min_length: 0
    max_length: 17
    mode: text

# ------------- SENSORS (UP TO 5 EYE DEVICES) ----------------------------

sensor:
  # Device 1
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye1_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 1 Temperature"
    humidity:
      name: "Teltonika EYE 1 Humidity"
    movement_count:
      name: "Teltonika EYE 1 Movement Count"
    pitch:
      name: "Teltonika EYE 1 Pitch"
    roll:
      name: "Teltonika EYE 1 Roll"
    battery_voltage:
      name: "Teltonika EYE 1 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 1 Battery Level"
    rssi:
      name: "Teltonika EYE 1 RSSI"

  # Device 2
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye2_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 2 Temperature"
    humidity:
      name: "Teltonika EYE 2 Humidity"
    movement_count:
      name: "Teltonika EYE 2 Movement Count"
    pitch:
      name: "Teltonika EYE 2 Pitch"
    roll:
      name: "Teltonika EYE 2 Roll"
    battery_voltage:
      name: "Teltonika EYE 2 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 2 Battery Level"
    rssi:
      name: "Teltonika EYE 2 RSSI"

  # Device 3
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye3_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 3 Temperature"
    humidity:
      name: "Teltonika EYE 3 Humidity"
    movement_count:
      name: "Teltonika EYE 3 Movement Count"
    pitch:
      name: "Teltonika EYE 3 Pitch"
    roll:
      name: "Teltonika EYE 3 Roll"
    battery_voltage:
      name: "Teltonika EYE 3 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 3 Battery Level"
    rssi:
      name: "Teltonika EYE 3 RSSI"

  # Device 4
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye4_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 4 Temperature"
    humidity:
      name: "Teltonika EYE 4 Humidity"
    movement_count:
      name: "Teltonika EYE 4 Movement Count"
    pitch:
      name: "Teltonika EYE 4 Pitch"
    roll:
      name: "Teltonika EYE 4 Roll"
    battery_voltage:
      name: "Teltonika EYE 4 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 4 Battery Level"
    rssi:
      name: "Teltonika EYE 4 RSSI"

  # Device 5
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye5_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 5 Temperature"
    humidity:
      name: "Teltonika EYE 5 Humidity"
    movement_count:
      name: "Teltonika EYE 5 Movement Count"
    pitch:
      name: "Teltonika EYE 5 Pitch"
    roll:
      name: "Teltonika EYE 5 Roll"
    battery_voltage:
      name: "Teltonika EYE 5 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 5 Battery Level"
    rssi:
      name: "Teltonika EYE 5 RSSI"

  # ------------- DISTANCE SENSORS FOR TELTONIKA DEVICES -------------------
  # Template sensors to calculate distance from RSSI
  # Note: The RSSI sensors are defined above with the teltonika_ble platform
  # These templates convert RSSI to estimated distance
  
  - platform: template
    name: "Teltonika EYE 1 Distance"
    unit_of_measurement: "m"
    accuracy_decimals: 1
    icon: "mdi:signal-distance-variant"
    lambda: |-
      // Get RSSI from the teltonika_ble RSSI sensor above
      // You'll need to reference the actual sensor entity
      // For now, returning a placeholder - configure after sensors are created
      return {};
    update_interval: 5s

  - platform: template
    name: "Teltonika EYE 2 Distance"
    unit_of_measurement: "m"
    accuracy_decimals: 1
    icon: "mdi:signal-distance-variant"
    lambda: |-
      return {};
    update_interval: 5s

  - platform: template
    name: "Teltonika EYE 3 Distance"
    unit_of_measurement: "m"
    accuracy_decimals: 1
    icon: "mdi:signal-distance-variant"
    lambda: |-
      return {};
    update_interval: 5s

  - platform: template
    name: "Teltonika EYE 4 Distance"
    unit_of_measurement: "m"
    accuracy_decimals: 1
    icon: "mdi:signal-distance-variant"
    lambda: |-
      return {};
    update_interval: 5s

  - platform: template
    name: "Teltonika EYE 5 Distance"
    unit_of_measurement: "m"
    accuracy_decimals: 1
    icon: "mdi:signal-distance-variant"
    lambda: |-
      return {};
    update_interval: 5s

  # ------------- IBEACON RSSI SENSORS ------------------------------------
  # Add your iBeacon MAC addresses here
  - platform: ble_rssi
    mac_address: "AA:BB:CC:DD:EE:F1"
    name: "iBeacon 1 RSSI"
    id: ibeacon1_rssi

  - platform: ble_rssi
    mac_address: "AA:BB:CC:DD:EE:F2"
    name: "iBeacon 2 RSSI"
    id: ibeacon2_rssi

  # ------------- IBEACON DISTANCE SENSORS --------------------------------
  - platform: template
    name: "iBeacon 1 Distance"
    unit_of_measurement: "m"
    accuracy_decimals: 1
    icon: "mdi:signal-distance-variant"
    lambda: |-
      float rssi = id(ibeacon1_rssi).state;
      if (isnan(rssi) || rssi == 0) return {};
      // iBeacon typical TxPower = -59 dBm
      float distance = pow(10.0, ((-59.0) - rssi) / (10.0 * 2.0));
      return distance;
    update_interval: 2s

  - platform: template
    name: "iBeacon 2 Distance"
    unit_of_measurement: "m"
    accuracy_decimals: 1
    icon: "mdi:signal-distance-variant"
    lambda: |-
      float rssi = id(ibeacon2_rssi).state;
      if (isnan(rssi) || rssi == 0) return {};
      float distance = pow(10.0, ((-59.0) - rssi) / (10.0 * 2.0));
      return distance;
    update_interval: 2s

  # ------------- EDDYSTONE RSSI SENSORS ----------------------------------
  # Eddystone beacons (replace with your beacon MAC addresses)
  - platform: ble_rssi
    mac_address: "BB:CC:DD:EE:FF:01"
    name: "Eddystone 1 RSSI"
    id: eddystone1_rssi

  - platform: ble_rssi
    mac_address: "BB:CC:DD:EE:FF:02"
    name: "Eddystone 2 RSSI"
    id: eddystone2_rssi

  # ------------- EDDYSTONE DISTANCE SENSORS ------------------------------
  - platform: template
    name: "Eddystone 1 Distance"
    unit_of_measurement: "m"
    accuracy_decimals: 1
    icon: "mdi:signal-distance-variant"
    lambda: |-
      float rssi = id(eddystone1_rssi).state;
      if (isnan(rssi) || rssi == 0) return {};
      // Eddystone typical TxPower = -20 to -4 dBm (adjust based on your beacons)
      float txPower = -20.0;  // Calibrate this value for your specific beacons
      float distance = pow(10.0, ((txPower) - rssi) / (10.0 * 2.0));
      return distance;
    update_interval: 2s

  - platform: template
    name: "Eddystone 2 Distance"
    unit_of_measurement: "m"
    accuracy_decimals: 1
    icon: "mdi:signal-distance-variant"
    lambda: |-
      float rssi = id(eddystone2_rssi).state;
      if (isnan(rssi) || rssi == 0) return {};
      float txPower = -20.0;
      float distance = pow(10.0, ((txPower) - rssi) / (10.0 * 2.0));
      return distance;
    update_interval: 2s

# ------------- BINARY SENSORS (UP TO 5 EYE DEVICES) ---------------------

binary_sensor:
  # Device 1
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye1_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 1 Movement"
    magnetic:
      name: "Teltonika EYE 1 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 1 Low Battery"

  # Device 2
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye2_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 2 Movement"
    magnetic:
      name: "Teltonika EYE 2 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 2 Low Battery"

  # Device 3
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye3_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 3 Movement"
    magnetic:
      name: "Teltonika EYE 3 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 3 Low Battery"

  # Device 4
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye4_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 4 Movement"
    magnetic:
      name: "Teltonika EYE 4 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 4 Low Battery"

  # Device 5
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye5_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 5 Movement"
    magnetic:
      name: "Teltonika EYE 5 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 5 Low Battery"

  # Door limit switch
  - platform: gpio
    name: "Gateway Door"
    pin:
      number: GPIO14
      mode:
        input: true
        pullup: true
      inverted: false
    device_class: door
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms

