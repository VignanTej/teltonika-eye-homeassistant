esphome:
  name: tez-teltonika-gateway
  name_add_mac_suffix: true
  friendly_name: Tez Teltonika EYE Gateway
  comment: ESP32 BLE bridge for Teltonika EYE sensors
  platformio_options:
    lib_ldf_mode: deep+

esp32:
  board: esp32dev
  framework:
    type: arduino

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Tez Teltonika Gateway Fallback"
    password: "TezDevice#123"

captive_portal:

logger:
  level: INFO
  logs:
    teltonika_ble: INFO
    esp32_ble_tracker: INFO

api:

ota:
  - platform: esphome
    id: ota_esphome

web_server:
  port: 80

# MQTT Configuration - Runtime configurable via UI
# Disabled on boot, use buttons to enable/disable and apply settings
mqtt:
  id: mqtt_client
  broker: ""
  port: 1883
  username: ""
  password: ""
  enable_on_boot: true
  discovery: true
  discovery_retain: true
  log_topic: null
  on_connect:
    - logger.log: "Connected to MQTT broker"
  on_disconnect:
    - logger.log: "Disconnected from MQTT broker"

# Globals to store MQTT configuration (restored on reboot, initialized from secrets)
globals:
  - id: mqtt_broker_global
    type: std::string
    restore_value: true
    max_restore_data_length: 100
    initial_value: !secret mqtt_broker
  
  - id: mqtt_port_global
    type: int
    restore_value: true
    initial_value: !secret mqtt_port
  
  - id: mqtt_username_global
    type: std::string
    restore_value: true
    max_restore_data_length: 50
    initial_value: !secret mqtt_username
  
  - id: mqtt_password_global
    type: std::string
    restore_value: true
    max_restore_data_length: 50
    initial_value: !secret mqtt_password
  
  - id: mqtt_topic_prefix_global
    type: std::string
    restore_value: true
    max_restore_data_length: 100
    initial_value: '"esphome"'

time:
  - platform: sntp
    id: sntp_time

esp32_ble_tracker:
  scan_parameters:
    interval: 320ms
    window: 30ms
    active: false

external_components:
  - source: github://VignanTej/teltonika-eye-homeassistant
    components:
      - teltonika_ble
    refresh: 0s

teltonika_ble:
  id: teltonika_ble_component
  discover: true
  timeout: 300s

# ---------------- DISCOVERED DEVICES TEXT SENSOR -------------------------

text_sensor:
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    discovered_devices:
      name: "Teltonika Devices Discovered"
      icon: "mdi:bluetooth-audio"

  - platform: wifi_info
    ip_address:
      name: "Gateway IP"
    mac_address:
      name: "Gateway MAC"

# ---------------- MQTT CONFIG UI (SHOW IN HA DEVICE UI) -----------------

# MQTT Port Configuration
number:
  - platform: template
    id: mqtt_port_number
    name: "MQTT Port"
    entity_category: config
    optimistic: false
    min_value: 1
    max_value: 65535
    step: 1
    mode: box
    lambda: |-
      return id(mqtt_port_global);
    set_action:
      - globals.set:
          id: mqtt_port_global
          value: !lambda 'return (int)x;'
      - logger.log:
          format: "MQTT port updated to %d. Click 'Apply MQTT Settings' to activate."
          args: ['(int)x']

text:
  # MQTT Broker Configuration
  - platform: template
    id: mqtt_broker_text
    name: "MQTT Broker"
    entity_category: config
    optimistic: false
    min_length: 0
    max_length: 100
    mode: text
    lambda: |-
      return id(mqtt_broker_global);
    set_action:
      - globals.set:
          id: mqtt_broker_global
          value: !lambda 'return x;'
      - logger.log:
          format: "MQTT broker updated to %s. Click 'Apply MQTT Settings' to activate."
          args: ['x.c_str()']

  # MQTT Username Configuration
  - platform: template
    id: mqtt_username_text
    name: "MQTT Username"
    entity_category: config
    optimistic: false
    min_length: 0
    max_length: 50
    mode: text
    lambda: |-
      return id(mqtt_username_global);
    set_action:
      - globals.set:
          id: mqtt_username_global
          value: !lambda 'return x;'
      - logger.log: "MQTT username updated. Click 'Apply MQTT Settings' to activate."

  # MQTT Password Configuration
  - platform: template
    id: mqtt_password_text
    name: "MQTT Password"
    entity_category: config
    optimistic: false
    min_length: 0
    max_length: 50
    mode: password
    lambda: |-
      return id(mqtt_password_global);
    set_action:
      - globals.set:
          id: mqtt_password_global
          value: !lambda 'return x;'
      - logger.log: "MQTT password updated. Click 'Apply MQTT Settings' to activate."

  # MQTT Topic Prefix Configuration
  - platform: template
    id: mqtt_topic_prefix_text
    name: "MQTT Topic Prefix"
    entity_category: config
    optimistic: false
    min_length: 0
    max_length: 100
    mode: text
    lambda: |-
      return id(mqtt_topic_prefix_global);
    set_action:
      - globals.set:
          id: mqtt_topic_prefix_global
          value: !lambda 'return x;'
      - logger.log:
          format: "MQTT topic prefix updated to %s. Click 'Apply MQTT Settings' to activate."
          args: ['x.c_str()']

  # Teltonika EYE MAC Addresses
  - platform: template
    id: eye1_mac_text
    name: "EYE 1 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "7C:D9:F4:13:BD:BF"
    min_length: 0
    max_length: 17
    mode: text

  - platform: template
    id: eye2_mac_text
    name: "EYE 2 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "7C:D9:F4:14:21:5D"
    min_length: 0
    max_length: 17
    mode: text

  - platform: template
    id: eye3_mac_text
    name: "EYE 3 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "00:00:00:00:00:00"
    min_length: 0
    max_length: 17
    mode: text

  - platform: template
    id: eye4_mac_text
    name: "EYE 4 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "00:00:00:00:00:00"
    min_length: 0
    max_length: 17
    mode: text

  - platform: template
    id: eye5_mac_text
    name: "EYE 5 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "00:00:00:00:00:00"
    min_length: 0
    max_length: 17
    mode: text

# ---------------- MQTT CONTROL BUTTONS -----------------------------------

button:
  - platform: template
    name: "Apply MQTT Settings"
    entity_category: config
    on_press:
      - lambda: |-
          id(mqtt_client)->set_broker_address(id(mqtt_broker_global));
          id(mqtt_client)->set_broker_port(id(mqtt_port_global));
          id(mqtt_client)->set_credentials(id(mqtt_username_global), id(mqtt_password_global));
          id(mqtt_client)->set_topic_prefix(id(mqtt_topic_prefix_global));
      - mqtt.disconnect:
      - delay: 1s
      - mqtt.connect:
      - logger.log: "MQTT settings applied and reconnecting..."

  - platform: template
    name: "Enable MQTT"
    entity_category: config
    on_press:
      - mqtt.enable:
      - logger.log: "MQTT enabled"

  - platform: template
    name: "Disable MQTT"
    entity_category: config
    on_press:
      - mqtt.disable:
      - logger.log: "MQTT disabled"

# ------------- SENSORS (UP TO 5 EYE DEVICES) ----------------------------

sensor:
  # Device 1
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye1_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 1 Temperature"
    humidity:
      name: "Teltonika EYE 1 Humidity"
    movement_count:
      name: "Teltonika EYE 1 Movement Count"
    pitch:
      name: "Teltonika EYE 1 Pitch"
    roll:
      name: "Teltonika EYE 1 Roll"
    battery_voltage:
      name: "Teltonika EYE 1 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 1 Battery Level"
    rssi:
      name: "Teltonika EYE 1 RSSI"

  # Device 2
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye2_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 2 Temperature"
    humidity:
      name: "Teltonika EYE 2 Humidity"
    movement_count:
      name: "Teltonika EYE 2 Movement Count"
    pitch:
      name: "Teltonika EYE 2 Pitch"
    roll:
      name: "Teltonika EYE 2 Roll"
    battery_voltage:
      name: "Teltonika EYE 2 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 2 Battery Level"
    rssi:
      name: "Teltonika EYE 2 RSSI"

  # Device 3
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye3_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 3 Temperature"
    humidity:
      name: "Teltonika EYE 3 Humidity"
    movement_count:
      name: "Teltonika EYE 3 Movement Count"
    pitch:
      name: "Teltonika EYE 3 Pitch"
    roll:
      name: "Teltonika EYE 3 Roll"
    battery_voltage:
      name: "Teltonika EYE 3 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 3 Battery Level"
    rssi:
      name: "Teltonika EYE 3 RSSI"

  # Device 4
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye4_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 4 Temperature"
    humidity:
      name: "Teltonika EYE 4 Humidity"
    movement_count:
      name: "Teltonika EYE 4 Movement Count"
    pitch:
      name: "Teltonika EYE 4 Pitch"
    roll:
      name: "Teltonika EYE 4 Roll"
    battery_voltage:
      name: "Teltonika EYE 4 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 4 Battery Level"
    rssi:
      name: "Teltonika EYE 4 RSSI"

  # Device 5
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye5_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 5 Temperature"
    humidity:
      name: "Teltonika EYE 5 Humidity"
    movement_count:
      name: "Teltonika EYE 5 Movement Count"
    pitch:
      name: "Teltonika EYE 5 Pitch"
    roll:
      name: "Teltonika EYE 5 Roll"
    battery_voltage:
      name: "Teltonika EYE 5 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 5 Battery Level"
    rssi:
      name: "Teltonika EYE 5 RSSI"

# ------------- BINARY SENSORS (UP TO 5 EYE DEVICES) ---------------------

binary_sensor:
  # Device 1
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye1_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 1 Movement"
    magnetic:
      name: "Teltonika EYE 1 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 1 Low Battery"

  # Device 2
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye2_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 2 Movement"
    magnetic:
      name: "Teltonika EYE 2 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 2 Low Battery"

  # Device 3
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye3_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 3 Movement"
    magnetic:
      name: "Teltonika EYE 3 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 3 Low Battery"

  # Device 4
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye4_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 4 Movement"
    magnetic:
      name: "Teltonika EYE 4 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 4 Low Battery"

  # Device 5
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye5_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 5 Movement"
    magnetic:
      name: "Teltonika EYE 5 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 5 Low Battery"

  # Door limit switch
  - platform: gpio
    name: "Gateway Door"
    pin:
      number: GPIO14
      mode:
        input: true
        pullup: true
      inverted: false
    device_class: door
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms

