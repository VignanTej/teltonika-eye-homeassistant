esphome:
  name: tez-teltonika-gateway
  name_add_mac_suffix: true
  friendly_name: Tez Teltonika EYE Gateway
  comment: ESP32 BLE bridge for Teltonika EYE sensors
  platformio_options:
    lib_ldf_mode: deep+

esp32:
  board: esp32dev
  framework:
    type: arduino
# WiFi Status LED on GPIO2 with detailed status patterns
output:
  - platform: gpio
    pin: GPIO2
    id: wifi_led_output

# Global variables to track connection states
globals:
  - id: wifi_connected
    type: bool
    initial_value: 'false'
  - id: mqtt_connected
    type: bool
    initial_value: 'false'
  - id: api_connected
    type: bool
    initial_value: 'false'
  - id: led_blink_mode
    type: int
    initial_value: '0'  # 0=off, 1=fast, 2=slow, 3=double, 4=solid
  - id: led_current_state
    type: bool
    initial_value: 'false'  # Track current LED state

# Scripts for LED patterns
script:
  # Update LED pattern based on connection states
  - id: led_update_state
    mode: restart
    then:
      - lambda: |-
          // Stop all blink scripts
          id(led_fast_blink).stop();
          id(led_slow_blink).stop();
          id(led_double_blink).stop();
          
          // Determine state and set pattern
          if (!id(wifi_connected)) {
            id(led_blink_mode) = 1;  // Fast blink
            id(led_fast_blink).execute();
          } else if (!id(mqtt_connected)) {
            id(led_blink_mode) = 2;  // Slow blink
            id(led_slow_blink).execute();
          } else if (!id(api_connected)) {
            id(led_blink_mode) = 3;  // Double blink (MQTT only)
            id(led_double_blink).execute();
          } else {
            id(led_blink_mode) = 4;  // Solid on (fully connected)
            id(led_current_state) = true;
            id(wifi_led_output).turn_on();
          }
  
  # Fast blink - WiFi disconnected (100ms on/off)
  - id: led_fast_blink
    mode: restart
    then:
      - while:
          condition:
            lambda: 'return id(led_blink_mode) == 1;'
          then:
            - lambda: 'id(led_current_state) = true;'
            - output.turn_on: wifi_led_output
            - delay: 100ms
            - lambda: 'id(led_current_state) = false;'
            - output.turn_off: wifi_led_output
            - delay: 100ms
  
  # Slow blink - WiFi only (500ms on/off)
  - id: led_slow_blink
    mode: restart
    then:
      - while:
          condition:
            lambda: 'return id(led_blink_mode) == 2;'
          then:
            - lambda: 'id(led_current_state) = true;'
            - output.turn_on: wifi_led_output
            - delay: 500ms
            - lambda: 'id(led_current_state) = false;'
            - output.turn_off: wifi_led_output
            - delay: 500ms
  
  # Double blink - WiFi + MQTT only (200ms on, 100ms off, 200ms on, 500ms off)
  - id: led_double_blink
    mode: restart
    then:
      - while:
          condition:
            lambda: 'return id(led_blink_mode) == 3;'
          then:
            - lambda: 'id(led_current_state) = true;'
            - output.turn_on: wifi_led_output
            - delay: 200ms
            - lambda: 'id(led_current_state) = false;'
            - output.turn_off: wifi_led_output
            - delay: 100ms
            - lambda: 'id(led_current_state) = true;'
            - output.turn_on: wifi_led_output
            - delay: 200ms
            - lambda: 'id(led_current_state) = false;'
            - output.turn_off: wifi_led_output
            - delay: 500ms
  
  # Activity pulse - brief opposite-state flash (150ms)
  - id: led_activity_pulse
    mode: restart
    then:
      - lambda: |-
          // Store current state and flash opposite
          bool was_on = id(led_current_state);
          if (was_on) {
            id(wifi_led_output).turn_off();
          } else {
            id(wifi_led_output).turn_on();
          }
      - delay: 150ms
      - lambda: |-
          // Restore previous state
          bool was_on = id(led_current_state);
          if (was_on) {
            id(wifi_led_output).turn_on();
          } else {
            id(wifi_led_output).turn_off();
          }

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # WiFi Status LED control
  on_connect:
    - logger.log: "WiFi connected - updating LED state"
    - lambda: 'id(wifi_connected) = true;'
    - script.execute: led_update_state
  on_disconnect:
    - logger.log: "WiFi disconnected - updating LED state"
    - lambda: 'id(wifi_connected) = false;'
    - script.execute: led_update_state
  ap:
    ssid: "Tez Teltonika Gateway Fallback"
    password: "TezDevice#123"

captive_portal:

logger:
  level: INFO
  logs:
    teltonika_ble: INFO
    esp32_ble_tracker: INFO

api:
  # When API connects, turn LED solid on
  on_client_connected:
    - logger.log: "API connected - updating LED state"
    - lambda: 'id(api_connected) = true;'
    - script.execute: led_update_state
  on_client_disconnected:
    - logger.log: "API disconnected - updating LED state"
    - lambda: 'id(api_connected) = false;'
    - script.execute: led_update_state

ota:
  - platform: esphome
    id: ota_esphome

web_server:
  port: 80

# MQTT Configuration - Configured from secrets.yaml
mqtt:
  broker: !secret mqtt_broker
  port: !secret mqtt_port
  username: !secret mqtt_username
  password: !secret mqtt_password
  discovery: true
  discovery_retain: false
  discovery_unique_id_generator: "mac"
  topic_prefix: "esphome"
  log_topic: null
  on_connect:
    - logger.log: "Connected to MQTT broker - updating LED state"
    - lambda: 'id(mqtt_connected) = true;'
    - script.execute: led_update_state
  on_disconnect:
    - logger.log: "Disconnected from MQTT broker - updating LED state"
    - lambda: 'id(mqtt_connected) = false;'
    - script.execute: led_update_state

time:
  - platform: sntp
    id: sntp_time

esp32_ble_tracker:
  scan_parameters:
    interval: 320ms
    window: 30ms
    active: false

external_components:
  - source: github://VignanTej/teltonika-eye-homeassistant
    components:
      - teltonika_ble
    refresh: 0s

teltonika_ble:
  id: teltonika_ble_component
  discover: true
  timeout: 300s

# ---------------- DISCOVERED DEVICES TEXT SENSOR -------------------------

text_sensor:
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    discovered_devices:
      name: "Teltonika Devices Discovered"
      icon: "mdi:bluetooth-audio"

  - platform: wifi_info
    ip_address:
      name: "Gateway IP"
    mac_address:
      name: "Gateway MAC"

# ---------------- DEVICE CONFIGURATION -----------------------------------

text:
  # Teltonika EYE MAC Addresses
  - platform: template
    id: eye1_mac_text
    name: "EYE 1 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "7C:D9:F4:13:BD:BF"
    min_length: 0
    max_length: 17
    mode: text

  - platform: template
    id: eye2_mac_text
    name: "EYE 2 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "7C:D9:F4:14:21:5D"
    min_length: 0
    max_length: 17
    mode: text

  - platform: template
    id: eye3_mac_text
    name: "EYE 3 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "00:00:00:00:00:00"
    min_length: 0
    max_length: 17
    mode: text

  - platform: template
    id: eye4_mac_text
    name: "EYE 4 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "00:00:00:00:00:00"
    min_length: 0
    max_length: 17
    mode: text

  - platform: template
    id: eye5_mac_text
    name: "EYE 5 MAC"
    entity_category: config
    optimistic: true
    restore_value: true
    initial_value: "00:00:00:00:00:00"
    min_length: 0
    max_length: 17
    mode: text

# ------------- SENSORS (UP TO 5 EYE DEVICES) ----------------------------

sensor:
  # Device 1
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye1_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 1 Temperature"
      on_value:
        - script.execute: led_activity_pulse
    humidity:
      name: "Teltonika EYE 1 Humidity"
    movement_count:
      name: "Teltonika EYE 1 Movement Count"
    pitch:
      name: "Teltonika EYE 1 Pitch"
    roll:
      name: "Teltonika EYE 1 Roll"
    battery_voltage:
      name: "Teltonika EYE 1 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 1 Battery Level"
    rssi:
      name: "Teltonika EYE 1 RSSI"

  # Device 2
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye2_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 2 Temperature"
      on_value:
        - script.execute: led_activity_pulse
    humidity:
      name: "Teltonika EYE 2 Humidity"
    movement_count:
      name: "Teltonika EYE 2 Movement Count"
    pitch:
      name: "Teltonika EYE 2 Pitch"
    roll:
      name: "Teltonika EYE 2 Roll"
    battery_voltage:
      name: "Teltonika EYE 2 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 2 Battery Level"
    rssi:
      name: "Teltonika EYE 2 RSSI"

  # Device 3
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye3_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 3 Temperature"
      on_value:
        - script.execute: led_activity_pulse
    humidity:
      name: "Teltonika EYE 3 Humidity"
    movement_count:
      name: "Teltonika EYE 3 Movement Count"
    pitch:
      name: "Teltonika EYE 3 Pitch"
    roll:
      name: "Teltonika EYE 3 Roll"
    battery_voltage:
      name: "Teltonika EYE 3 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 3 Battery Level"
    rssi:
      name: "Teltonika EYE 3 RSSI"

  # Device 4
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye4_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 4 Temperature"
      on_value:
        - script.execute: led_activity_pulse
    humidity:
      name: "Teltonika EYE 4 Humidity"
    movement_count:
      name: "Teltonika EYE 4 Movement Count"
    pitch:
      name: "Teltonika EYE 4 Pitch"
    roll:
      name: "Teltonika EYE 4 Roll"
    battery_voltage:
      name: "Teltonika EYE 4 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 4 Battery Level"
    rssi:
      name: "Teltonika EYE 4 RSSI"

  # Device 5
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye5_mac_text).state.c_str();
    temperature:
      name: "Teltonika EYE 5 Temperature"
      on_value:
        - script.execute: led_activity_pulse
    humidity:
      name: "Teltonika EYE 5 Humidity"
    movement_count:
      name: "Teltonika EYE 5 Movement Count"
    pitch:
      name: "Teltonika EYE 5 Pitch"
    roll:
      name: "Teltonika EYE 5 Roll"
    battery_voltage:
      name: "Teltonika EYE 5 Battery Voltage"
    battery_level:
      name: "Teltonika EYE 5 Battery Level"
    rssi:
      name: "Teltonika EYE 5 RSSI"

# ------------- BINARY SENSORS (UP TO 5 EYE DEVICES) ---------------------

binary_sensor:
  # Device 1
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye1_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 1 Movement"
    magnetic:
      name: "Teltonika EYE 1 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 1 Low Battery"

  # Device 2
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye2_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 2 Movement"
    magnetic:
      name: "Teltonika EYE 2 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 2 Low Battery"

  # Device 3
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye3_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 3 Movement"
    magnetic:
      name: "Teltonika EYE 3 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 3 Low Battery"

  # Device 4
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye4_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 4 Movement"
    magnetic:
      name: "Teltonika EYE 4 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 4 Low Battery"

  # Device 5
  - platform: teltonika_ble
    teltonika_ble_id: teltonika_ble_component
    mac_address: !lambda |-
      return id(eye5_mac_text).state.c_str();
    movement:
      name: "Teltonika EYE 5 Movement"
    magnetic:
      name: "Teltonika EYE 5 Magnetic Field"
    low_battery:
      name: "Teltonika EYE 5 Low Battery"

  # Door limit switch
  - platform: gpio
    name: "Gateway Door"
    pin:
      number: GPIO14
      mode:
        input: true
        pullup: true
      inverted: false
    device_class: door
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_state:
      - script.execute: led_activity_pulse

